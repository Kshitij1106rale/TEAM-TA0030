/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model for all personal data,
 * ensuring that users can only access information they own. All user-specific data is hierarchically
 * organized under a `/users/{userId}` path. In contrast, global, non-sensitive reference data
 * (like crop types or market information) is stored in top-level collections and is made read-only
 * for all authenticated users to consume.
 *
 * Data Structure: The structure is bifurcated. A private, user-centric hierarchy exists at
 * `/users/{userId}/...`, containing a user's farms, crop cycles, and related data. This
 * deep nesting naturally scopes queries. Parallel to this are top-level collections like `/crops`
 * and `/diseases` which serve as a public, read-only data library for the application.
 *
 * Key Security Decisions:
 * - User data is strictly isolated; users cannot see or interact with another user's data.
 * - Listing users from the `/userProfiles` collection is explicitly forbidden to prevent user enumeration.
 * - Global data collections (`/crops`, `/diseases`, etc.) are read-only for client applications.
 *   Writes to these collections must be performed by a trusted backend service or admin SDK.
 * - All write operations require user authentication.
 *
 * Denormalization for Authorization: To ensure fast and secure access control, this ruleset relies
 * on denormalized ownership fields. For example, a `Farm` document at `/users/{userId}/farms/{farmId}`
 * contains a `userId` field. This allows rules to verify ownership directly from the document
 * (`resource.data.userId == userId`) without performing costly and slow `get()` calls to parent
 * documents. This strategy is applied throughout the user data tree for simplicity and performance.
 *
 * Structural Segregation: User-private data (e.g., a user's farms) is stored in subcollections
 * under the user's ID. Public data (e.g., a list of all possible crop types) is stored in separate,
 * top-level collections. This clear separation allows for simple and highly performant security
 * rules for `list` operations, as a query on a user-specific path is inherently filtered to that user.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     * This is the foundation of the user-ownership model.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Ensures an operation is performed by the owner on an existing document.
     * Crucial for secure update and delete operations.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    // --- UserProfile Validation ---
    function isCreatingOwnProfile(userId) {
      return isOwner(userId) && request.resource.data.id == userId;
    }
    function isUpdatingOwnProfile(userId) {
      // The user's own `id` field must be immutable.
      return isExistingOwner(userId) && request.resource.data.id == resource.data.id;
    }

    // --- Farm Validation ---
    function isCreatingOwnFarm(userId) {
      // Enforce that the new farm document is correctly linked to the owner.
      return isOwner(userId) && request.resource.data.userId == userId;
    }
    function isUpdatingOwnFarm(userId) {
      // The `userId` link must be immutable.
      return isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
    }

    // --- Nested Document Validation ---
    function isCreatingOwnCropCycle(userId, farmId) {
      return isOwner(userId) && request.resource.data.farmId == farmId;
    }
    function isUpdatingOwnCropCycle(userId) {
      return isExistingOwner(userId) && request.resource.data.farmId == resource.data.farmId;
    }

    function isCreatingOwnCropImage(userId, cropCycleId) {
      // Enforces that the new image is linked to both the owner and the parent crop cycle.
      return isOwner(userId) && request.resource.data.userId == userId
          && request.resource.data.cropCycleId == cropCycleId;
    }
    function isUpdatingOwnCropImage(userId) {
      // Linkages to owner and parent are immutable.
      return isExistingOwner(userId) && request.resource.data.userId == resource.data.userId
          && request.resource.data.cropCycleId == resource.data.cropCycleId;
    }

    function isCreatingOwnDetectionResult(userId, cropImageId) {
      return isOwner(userId) && request.resource.data.cropImageId == cropImageId;
    }
    function isUpdatingOwnDetectionResult(userId) {
      return isExistingOwner(userId) && request.resource.data.cropImageId == resource.data.cropImageId;
    }

    function isCreatingOwnProfitEstimation(userId, cropCycleId) {
      return isOwner(userId) && request.resource.data.cropCycleId == cropCycleId;
    }
    function isUpdatingOwnProfitEstimation(userId) {
      return isExistingOwner(userId) && request.resource.data.cropCycleId == resource.data.cropCycleId;
    }

    function isCreatingOwnWeatherAdvisory(userId, farmId) {
      return isOwner(userId) && request.resource.data.farmId == farmId;
    }
    function isUpdatingOwnWeatherAdvisory(userId) {
      return isExistingOwner(userId) && request.resource.data.farmId == resource.data.farmId;
    }

    // --------------------------------------------------------------------
    // User Data Collections
    // --------------------------------------------------------------------

    /**
     * @description A user can create, read, update, and delete their own profile.
     * @path /userProfiles/{userId}
     * @allow (create) An authenticated user with auth.uid 'user123' creates their own profile at `/userProfiles/user123`.
     * @deny (list) Any user attempting to list all documents in the `/userProfiles` collection.
     * @principle Prevents user enumeration and enforces self-service profile management.
     */
    match /userProfiles/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Disallow listing to prevent user enumeration
      allow create: if isCreatingOwnProfile(userId);
      allow update: if isUpdatingOwnProfile(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Defines rules for all user-specific nested data. Access is granted only to the owner.
     * @path /users/{userId}
     * @allow (read) User 'user123' can access any document within `/users/user123/...`.
     * @deny (read) User 'user456' cannot access any document within `/users/user123/...`.
     * @principle Establishes a secure data boundary for all user-owned information.
     */
    match /users/{userId} {

      /**
       * @description A user can manage the farms they own.
       * @path /users/{userId}/farms/{farmId}
       * @allow (create) User 'user123' creates a new farm document in their own `/farms` subcollection.
       * @deny (update) User 'user456' attempts to update a farm document belonging to 'user123'.
       * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
       */
      match /farms/{farmId} {
        allow get, list: if isOwner(userId);
        allow create: if isCreatingOwnFarm(userId);
        allow update: if isUpdatingOwnFarm(userId);
        allow delete: if isExistingOwner(userId);

        /**
         * @description A user can manage crop cycles for their own farms.
         * @path /users/{userId}/farms/{farmId}/cropCycles/{cropCycleId}
         * @allow (list) User 'user123' lists all crop cycles for their farm 'farmABC'.
         * @deny (create) User 'user123' tries to create a crop cycle for a farm owned by 'user456'.
         * @principle Validates relational integrity to the parent farm and maintains ownership.
         */
        match /cropCycles/{cropCycleId} {
          allow get, list: if isOwner(userId);
          allow create: if isCreatingOwnCropCycle(userId, farmId);
          allow update: if isUpdatingOwnCropCycle(userId);
          allow delete: if isExistingOwner(userId);

          /**
           * @description A user can manage images for their own crop cycles.
           * @path /users/{userId}/farms/{farmId}/cropCycles/{cropCycleId}/cropImages/{cropImageId}
           * @allow (create) User 'user123' uploads an image for their crop cycle 'cycleXYZ'.
           * @deny (delete) User 'user456' attempts to delete an image belonging to 'user123'.
           * @principle Enforces document ownership and validates relational integrity.
           */
          match /cropImages/{cropImageId} {
            allow get, list: if isOwner(userId);
            allow create: if isCreatingOwnCropImage(userId, cropCycleId);
            allow update: if isUpdatingOwnCropImage(userId);
            allow delete: if isExistingOwner(userId);

            /**
             * @description A user can read disease detection results for their own crop images.
             * @path /users/{userId}/farms/{farmId}/cropCycles/{cropCycleId}/cropImages/{cropImageId}/diseaseDetectionResults/{detectionResultId}
             * @allow (get) User 'user123' reads a detection result for an image they uploaded.
             * @deny (create) A user attempts to create a detection result (this is likely a server-side process).
             * @principle Restricts access based on the ownership of the parent data tree.
             */
            match /diseaseDetectionResults/{detectionResultId} {
              allow get, list: if isOwner(userId);
              allow create: if isCreatingOwnDetectionResult(userId, cropImageId);
              allow update: if isUpdatingOwnDetectionResult(userId);
              allow delete: if isExistingOwner(userId);
            }
          }

          /**
           * @description A user can manage profit estimations for their own crop cycles.
           * @path /users/{userId}/farms/{farmId}/cropCycles/{cropCycleId}/profitEstimations/{estimationId}
           * @allow (get) User 'user123' reads a profit estimation for their crop cycle 'cycleXYZ'.
           * @deny (update) User 'user456' attempts to update an estimation belonging to 'user123'.
           * @principle Restricts access based on the ownership of the parent data tree.
           */
          match /profitEstimations/{estimationId} {
            allow get, list: if isOwner(userId);
            allow create: if isCreatingOwnProfitEstimation(userId, cropCycleId);
            allow update: if isUpdatingOwnProfitEstimation(userId);
            allow delete: if isExistingOwner(userId);
          }
        }

        /**
         * @description A user can manage weather advisories for their own farms.
         * @path /users/{userId}/farms/{farmId}/weatherAdvisories/{advisoryId}
         * @allow (get) User 'user123' reads a weather advisory for their farm 'farmABC'.
         * @deny (create) User 'user456' attempts to create an advisory for a farm owned by 'user123'.
         * @principle Restricts access based on the ownership of the parent data tree.
         */
        match /weatherAdvisories/{advisoryId} {
          allow get, list: if isOwner(userId);
          allow create: if isCreatingOwnWeatherAdvisory(userId, farmId);
          allow update: if isUpdatingOwnWeatherAdvisory(userId);
          allow delete: if isExistingOwner(userId);
        }
      }
    }

    // --------------------------------------------------------------------
    // Global Read-Only Collections
    // --------------------------------------------------------------------

    /**
     * @description Global collection of crop types. Read-only for all authenticated users.
     * @path /crops/{cropId}
     * @allow (get, list) Any authenticated user can read crop information.
     * @deny (create, update, delete) No client is allowed to modify the global crop list.
     * @principle Provides public, read-only access to common reference data.
     */
    match /crops/{cropId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description Global collection of known diseases. Read-only for all authenticated users.
     * @path /diseases/{diseaseId}
     * @allow (get, list) Any authenticated user can read disease information.
     * @deny (create, update, delete) No client is allowed to modify the global disease list.
     * @principle Provides public, read-only access to common reference data.
     */
    match /diseases/{diseaseId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description Global collection of recommendations. Read-only for all authenticated users.
     * @path /recommendations/{recommendationId}
     * @allow (get, list) Any authenticated user can read recommendations.
     * @deny (create, update, delete) No client is allowed to modify global recommendations.
     * @principle Provides public, read-only access to common reference data.
     */
    match /recommendations/{recommendationId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description Global collection of mandi markets. Read-only for all authenticated users.
     * @path /mandiMarkets/{mandiMarketId}
     * @allow (get, list) Any authenticated user can read market information.
     * @deny (create, update, delete) No client is allowed to modify the global market list.
     * @principle Provides public, read-only access to common reference data.
     */
    match /mandiMarkets/{mandiMarketId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description Global collection of mandi price records. Read-only for all authenticated users.
     * @path /mandiPriceRecords/{mandiPriceRecordId}
     * @allow (get, list) Any authenticated user can read price data.
     * @deny (create, update, delete) No client is allowed to modify historical price data.
     * @principle Provides public, read-only access to common reference data.
     */
    match /mandiPriceRecords/{mandiPriceRecordId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }
  }
}